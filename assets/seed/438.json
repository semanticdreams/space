{"id": "438", "type": "class", "data": "{\"code_str\": \"class GraphEntityViewChild:\\n    def __init__(self, graph_entity_view, entity, focus_parent=None):\\n        self.focus = focus_parent.add_child(self)\\n        self.graph_entity_view = graph_entity_view\\n        self.entity = entity\\n        assert isinstance(self.entity.id, str)\\n        self.view_mode = 'point'\\n        self.dialog_actions = [\\n            ('icon:add', self.create_child_node),\\n            ('icon:remove', lambda: self.graph_entity_view.remove_node(self.entity.id)),\\n        ]\\n        self.point = z.Point(color=self.entity.color, size=8)\\n        self.layout = z.Layout(children=[self.point.layout], measurer=self.measurer,\\n                              layouter=self.layouter)\\n        self.dialog = None\\n        self.obj = None\\n\\n        self.layout.position = np.array(self.graph_entity_view.entity.positions.get(self.entity.id, (0, 0, 0)), float)\\n\\n        self.entity.changed.connect(self.on_entity_changed)\\n\\n    def create_child_node(self):\\n        graph_entity = self.graph_entity_view.entity\\n        child_entity = self.entity.create()\\n        graph_entity.add_node(child_entity, position=(self.layout.position*1.2).tolist())\\n        graph_entity.add_edge(self.entity, child_entity)\\n        graph_entity.save()\\n        self.graph_entity_view.update_graph()\\n\\n    def create_dialog(self):\\n        return z.Dialog(\\n            '{} ({})'.format(self.entity, self.graph_entity_view.entity), self.obj,\\n            actions=self.dialog_actions,\\n            color=self.entity.color\\n        )\\n\\n    def measurer(self):\\n        self.layout.children[0].measurer()\\n        self.layout.measure = self.layout.children[0].measure\\n\\n    def layouter(self):\\n        child = self.layout.children[0]\\n        child.position = self.layout.position\\n        child.rotation = self.layout.rotation\\n        child.size = self.layout.size\\n        child.layouter()\\n\\n    def on_entity_changed(self):\\n        if self.view_mode == 'preview':\\n            self.switch_view_mode('point')\\n            self.switch_view_mode('preview')\\n\\n    def switch_view_mode(self, view_mode):\\n        if view_mode == self.view_mode:\\n            return\\n        if view_mode == 'view':\\n            if self.point:\\n                self.point.drop()\\n                self.point = None\\n            self.obj = self.entity.view(self.entity, focus_parent=self.focus)\\n            if self.dialog:\\n                self.dialog.reset_child(self.obj)\\n            else:\\n                self.dialog = self.create_dialog()\\n                self.layout.set_children([self.dialog.layout])\\n        elif view_mode == 'preview':\\n            if self.point:\\n                self.point.drop()\\n                self.point = None\\n            self.obj = self.entity.preview(self.entity, focus_parent=self.focus)\\n            if self.dialog:\\n                self.dialog.reset_child(self.obj)\\n            else:\\n                self.dialog = self.create_dialog()\\n                self.layout.set_children([self.dialog.layout])\\n        else:\\n            self.dialog.drop()\\n            self.obj.drop()\\n            self.dialog = None\\n            self.obj = None\\n            self.point = z.Point(color=self.entity.color, size=8)\\n            self.layout.set_children([self.point.layout])\\n        self.layout.mark_measure_dirty()\\n        self.view_mode = view_mode\\n\\n    def get_position(self):\\n        return self.layout.position\\n\\n    def set_position(self, position):\\n        self.layout.position = position\\n        self.layout.mark_layout_dirty()\\n        self.graph_entity_view.update_edge_lines()\\n\\n    def set_rotation(self, rotation):\\n        self.layout.rotation = rotation\\n        self.layout.mark_layout_dirty()\\n\\n    def intersect(self, ray):\\n        return self.layout.intersect(ray)\\n\\n    def drop(self):\\n        self.entity.changed.disconnect(self.on_entity_changed)\\n        if self.dialog:\\n            self.dialog.drop()\\n        if self.obj:\\n            self.obj.drop()\\n        if self.point:\\n            self.point.drop()\\n        self.focus.drop()\\n\", \"name\": \"GraphEntityViewChild\"}", "created_at": null, "updated_at": 1754239007.5027318}