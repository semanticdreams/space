{"id": "170", "type": "class", "data": "{\"code_str\": \"class CodebookView:\\n\\n    def __init__(self, codebook):\\n        self.codebook = codebook\\n        self.name = z.ReactiveValue(self.make_name())\\n        self.focus = world.focus.add_child(self)\\n        self.name_input = Input(text=self.codebook.data['name'] or '', focus_parent=self.focus)\\n        self.name_input.submitted.connect(self.name_submitted)\\n        self.default_kernel_input = Input(text=str(self.codebook.data['default_kernel']), focus_parent=self.focus)\\n        self.default_kernel_input.submitted.connect(self.default_kernel_submitted)\\n        self.code_id_input = Input(text='', focus_parent=self.focus)\\n        self.code_id_input.submitted.connect(self.code_id_submitted)\\n        actions = [('reload', self.load_codes), ('delete', self.delete_triggered), ('new code', self.new_code_triggered)]\\n        self.buttons = []\\n        for (name, func) in actions:\\n            button = Button(name, focus_parent=self.focus)\\n            button.clicked.connect(lambda f, i, d, func=func: func())\\n            self.buttons.append(button)\\n        self.spacer = Spacer()\\n        self.row = Flex(children=[FlexChild(self.name_input), FlexChild(self.default_kernel_input), FlexChild(self.code_id_input), *[FlexChild(x) for x in self.buttons], FlexChild(self.spacer, flex=1)])\\n        self.list_view = ListView([], focus_parent=self.focus, show_head=False, builder=self.item_builder)\\n        self.column = Flex(xalign='largest', axis='y', children=[FlexChild(self.row), FlexChild(self.list_view)])\\n        self.layout = self.column.layout\\n        self.codes = []\\n        self.errors = {}\\n        self.outputs = {}\\n        self.running_codes = set()\\n        self.done_codes = set()\\n        self.load_codes()\\n\\n    def item_builder(self, item, context):\\n        if item[0] == 'code':\\n            code = item[1]\\n            return ContextButton(label=code['code'], focus_parent=context['focus_parent'], color=(0.8, 0.8, 1, 1) if code['id'] in self.running_codes else (0.9, 0.9, 0.4, 1) if code['id'] in self.done_codes else (1.0, 1.0, 0.8, 1), actions=[('run', lambda : self.run_code_triggered(code)), ('get', lambda : self.get_code_triggered(code)), ('move up', lambda : self.move_code_up_triggered(code)), ('move down', lambda : self.move_code_down_triggered(code)), ('edit', lambda : self.edit_code_triggered(code)), ('edit kernel', lambda : self.edit_code_kernel_triggered(code)), ('delete code', lambda : self.delete_code_triggered(code)), ('remove from codebook', lambda : self.remove_code_from_codebook_triggered(code))])\\n        elif item[0] == 'output':\\n            output = item[1]\\n            return ContextButton(label=output, focus_parent=context['focus_parent'], color=(0.6, 1.0, 0.6, 1), actions=[('edit', lambda : world.dialogs.edit_string(output))])\\n        elif item[0] == 'error':\\n            error = item[1]\\n            return ContextButton(label=error, focus_parent=context['focus_parent'], color=(1.0, 0.6, 0.6, 1), actions=[('edit', lambda : world.dialogs.edit_string(error))])\\n\\n    def run_code_triggered(self, code):\\n        self.outputs.pop(code['id'], None)\\n        self.errors.pop(code['id'], None)\\n        self.done_codes.discard(code['id'])\\n        self.running_codes.add(code['id'])\\n        world.codes.run_code(code, catch_errors=True, registers=self.codebook.registers, callback=lambda result: self.on_code_callback(code, result))\\n        self.update_items()\\n\\n    def on_code_callback(self, code, result):\\n        self.codebook.registers = result['registers']\\n        if (output := (result['output'] or '').strip()):\\n            self.outputs[code['id']] = output\\n        if (error := (result['error'] or '').strip()):\\n            self.errors[code['id']] = error\\n        else:\\n            self.done_codes.add(code['id'])\\n        self.running_codes.discard(code['id'])\\n        self.update_items()\\n\\n    def get_code_triggered(self, code):\\n        world.floaties.add(z.CodeView(code))\\n\\n    def move_code_up_triggered(self, code):\\n        self.codebook.move_code_up(code)\\n        self.load_codes()\\n\\n    def move_code_down_triggered(self, code):\\n        self.codebook.move_code_down(code)\\n        self.load_codes()\\n\\n    def edit_code_triggered(self, code):\\n        world.codes.edit_code(code)\\n        self.update_items()\\n\\n    def edit_code_kernel_triggered(self, code):\\n        world.codes.edit_code_kernel(code)\\n\\n    def delete_code_triggered(self, code):\\n        self.codebook.delete_code(code)\\n        self.outputs.pop(code['id'], None)\\n        self.errors.pop(code['id'], None)\\n        self.codes = [x for x in self.codes if x['id'] != code['id']]\\n        self.update_items()\\n\\n    def remove_code_from_codebook_triggered(self, code):\\n        self.codebook.remove_code_from_codebook(code['id'])\\n        self.outputs.pop(code['id'], None)\\n        self.errors.pop(code['id'], None)\\n        self.codes = [x for x in self.codes if x['id'] != code['id']]\\n        self.update_items()\\n\\n    def update_items(self):\\n        items = []\\n        for code in self.codes:\\n            items.append(('code', code))\\n            if (output := self.outputs.get(code['id'])):\\n                items.append(('output', output))\\n            if (error := self.errors.get(code['id'])):\\n                items.append(('error', error))\\n        self.list_view.set_items(items)\\n\\n    def load_codes(self):\\n        self.codes = self.codebook.get_codebook_codes()\\n        self.update_items()\\n\\n    def code_id_submitted(self):\\n        code_id = int(self.code_id_input.text)\\n        self.codebook.add_code(code_id)\\n        self.load_codes()\\n\\n    def new_code_triggered(self):\\n        self.codebook.new_code()\\n        self.load_codes()\\n\\n    def make_name(self):\\n        return f\\\"codebook: {self.codebook.data['name']}\\\"\\n\\n    def delete_triggered(self):\\n        self.codebook.drop_codebook()\\n        world.floaties.drop_obj(self)\\n\\n    def name_submitted(self):\\n        self.codebook.update_name(self.name_input.text.strip())\\n        self.name.set(self.make_name())\\n\\n    def default_kernel_submitted(self):\\n        self.codebook.update_default_kernel(int(self.default_kernel_input.text.strip()))\\n\\n    def drop(self):\\n        self.column.drop()\\n        self.row.drop()\\n        self.list_view.drop()\\n        self.name_input.drop()\\n        self.default_kernel_input.drop()\\n        self.code_id_input.drop()\\n        self.spacer.drop()\\n        for button in self.buttons:\\n            button.drop()\\n        self.focus.drop()\\n\", \"name\": \"CodebookView\"}", "created_at": null, "updated_at": 1754736945.4840393}