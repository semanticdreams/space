{"id": "302", "type": "class", "data": "{\"code_str\": \"import traceback\\nimport io\\n\\n\\nclass Codebook:\\n    def __init__(self, data):\\n        self.data = data\\n        self.registers = {}\\n\\n    def add_code(self, code_id, pos=None):\\n        codebook_id = self.data['id']\\n        if pos is None:\\n            pos = (self.get_max_pos() or 0) + 1\\n        with world.db:\\n            world.db.execute(\\n                'insert into codebook_codes'\\n                ' (codebook_id, code_id, pos) values (?, ?, ?)',\\n                (codebook_id, code_id, pos))\\n\\n    def new_code(self):\\n        code_id = world.codes.create_code()\\n        world.codes.update_code_kernel(code_id, self.data['default_kernel'])\\n        self.add_code(code_id)\\n\\n    def get_max_pos(self):\\n        codebook_id = self.data['id']\\n        return one(world.db.execute(\\n            'select max(pos) as max_pos from codebook_codes'\\n            ' where codebook_id = ?',\\n            (codebook_id,)).fetchall())['max_pos']\\n\\n    def move_code_up(self, code):\\n        prev_code = one_or_none(\\n            world.db.execute(\\n                'select code_id, pos from codebook_codes where codebook_id = ?'\\n                ' and pos < ? order by pos desc limit 1',\\n                (code['codebook_id'], code['pos'])).fetchall())\\n        if prev_code:\\n            with world.db:\\n                world.db.execute(\\n                    'update codebook_codes set pos = ? where codebook_id = ?'\\n                    ' and code_id = ? and pos = ?',\\n                    (prev_code['pos'], code['codebook_id'], code['id'], code['pos']))\\n                world.db.execute(\\n                    'update codebook_codes set pos = ? where codebook_id = ?'\\n                    ' and code_id = ? and pos = ?',\\n                    (code['pos'], code['codebook_id'], prev_code['code_id'], prev_code['pos']))\\n\\n    def move_code_down(self, code):\\n        next_code = one_or_none(\\n            world.db.execute(\\n                'select code_id, pos from codebook_codes where codebook_id = ?'\\n                ' and pos > ? order by pos asc limit 1',\\n                (code['codebook_id'], code['pos'])).fetchall())\\n        if next_code:\\n            with world.db:\\n                world.db.execute(\\n                    'update codebook_codes set pos = ? where codebook_id = ?'\\n                    ' and code_id = ? and pos = ?',\\n                    (next_code['pos'], code['codebook_id'], code['id'], code['pos']))\\n                world.db.execute(\\n                    'update codebook_codes set pos = ? where codebook_id = ?'\\n                    ' and code_id = ? and pos = ?',\\n                    (code['pos'], code['codebook_id'], next_code['code_id'], next_code['pos']))\\n\\n\\n    def get_codebook_codes(self):\\n        data = world.db.execute('select b.pos, b.codebook_id, c.* from codebook_codes b'\\n                                ' join codes c on b.code_id = c.id'\\n                                ' where codebook_id = ?'\\n                                ' order by b.pos asc',\\n                               (self.data['id'],)).fetchall()\\n        return list(map(dict, data))\\n\\n    def update_name(self, name):\\n        self.data['name'] = name\\n        with world.db:\\n            world.db.execute('update codebooks set name = ? where id = ?',\\n                             (self.data['name'], self.data['id']))\\n\\n    def update_default_kernel(self, kernel_id):\\n        self.data['default_kernel'] = kernel_id\\n        with world.db:\\n            world.db.execute('update codebooks set default_kernel = ? where id = ?',\\n                             (self.data['default_kernel'], self.data['id']))\\n\\n    def delete_code(self, code):\\n        self.remove_code_from_codebook(code['id'])\\n        world.codes.delete_code(code)\\n\\n    def remove_code_from_codebook(self, code_id):\\n        with world.db:\\n            world.db.execute('delete from codebook_codes where codebook_id = ? and code_id = ?',\\n                             (self.data['id'], code_id))\", \"name\": \"Codebook\"}", "created_at": null, "updated_at": 1754736945.4765255}