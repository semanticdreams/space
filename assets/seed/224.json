{"id": "224", "type": "class", "data": "{\"code_str\": \"from util import adjust_perceptual_color_brightness, get_luminance, wrap_text as wrap\\n\\n\\nclass ContextButton:\\n    def __init__(self, _world=None, model=None, focus_parent=None, line_numbers=False, title=None,\\n                 label=None, color=None, actions=None, max_lines=None, focusable=True,\\n                 foreground_color=None, padding_insets=(1, 0.8), font_scale=2,\\n                 hud=False, data=None):\\n        self.focusable = focusable\\n        self.data = data\\n        self.line_numbers = line_numbers\\n        self.max_lines = max_lines\\n        self.title = title or ''\\n        self.world = world\\n        self.model = model\\n        self.hud = hud\\n        self.color = np.asarray(model.get_color() if model else (color if color is not None else world.themes.theme.button_background_color), float)\\n        self.unfocused_color = self.color.copy()\\n\\n        if foreground_color is None:\\n            foreground_color = world.themes.theme.gray[900] if get_luminance(self.color) > 0.22 else world.themes.theme.gray[100]\\n\\n        self.button = z.Button(background_color=self.color, focusable=False, hud=hud, wrap=80,\\n                                       padding_insets=padding_insets,\\n                                       font_scale=font_scale,\\n                                       centered=False, foreground_color=foreground_color,\\n                                       on_click=self.on_click, on_right_click=self.on_right_click)\\n\\n        self.focus = None\\n        if focusable:\\n            self.focused = False\\n            self.focus = focus_parent.add_child(obj=self, on_changed=self.on_focus_changed) \\\\\\n                    if focus_parent else world.focus.add_child(self, on_changed=self.on_focus_changed)\\n\\n        self.actions = self.model.get_actions() if model else actions\\n\\n        #if self.title:\\n        #    self.tooltip = world.tooltips.create_tooltip(self.button, self.title)\\n        #else:\\n        #    self.tooltip = None\\n\\n        if model:\\n            self.label_model = model.get_label()\\n            if isinstance(self.label_model, str):\\n                self.label = self.label_model\\n            elif isinstance(self.label_model, z.ReactiveValue):\\n                self.label = self.label_model.get()\\n                self.label_model.changed.connect(self.label_changed)\\n            else:\\n                raise Exception('Unknown label model type: {}'.format(type(self.label_model)))\\n        else:\\n            self.label = label or ''\\n\\n        self.button.set_text(wrap(self.label, max_lines=self.max_lines))\\n\\n        if self.line_numbers:\\n            self.button.label.line_numbers = True\\n\\n        #self.triggered = Signal()\\n\\n        self.layout = self.button.layout\\n\\n        self.spatiolator = z.Spatiolator(self.layout, self.button)\\n\\n        if not self.hud:\\n            world.camera.debounced_camera_position.changed.connect(self.debounced_camera_position_changed)\\n\\n    def set_hud(self, hud):\\n        if self.hud and not hud:\\n            world.camera.debounced_camera_position.changed.connect(self.debounced_camera_position_changed)\\n        elif not self.hud and hud:\\n            world.camera.debounced_camera_position.changed.disconnect(self.debounced_camera_position_changed)\\n\\n        self.hud = hud\\n        self.button.set_hud(hud)\\n\\n    def __repr__(self):\\n        return '<ContextButton: {}>'.format(self.title)\\n\\n    def set_label(self, text):\\n        self.label = text\\n        self.button.set_text(wrap(self.label, max_lines=self.max_lines))\\n\\n    def set_color(self, color):\\n        self.color = np.asarray(color, float)\\n        self.unfocused_color = self.color.copy()\\n        self.button.set_color(np.asarray(color, float))\\n\\n    def on_focus_changed(self, value):\\n        assert self.focused != value\\n        self.focused = value\\n        if value:\\n            world.vim.modes['normal'].add_action_group(z.VimActionGroup('context-button', [\\n                z.VimAction('open menu', self.open_context_menu, sdl2.SDLK_BACKSLASH),\\n                z.VimAction('trigger', lambda: self.on_click(None, None, None), sdl2.SDLK_RETURN),\\n            ]))\\n        else:\\n            world.vim.modes['normal'].remove_action_group('context-button')\\n\\n#        self.button.rectangle.set_color(adjust_perceptual_color_brightness(self.unfocused_color, 0.2 if value else 0))\\n        self.button.rectangle.set_color(world.themes.theme.focused_background_color \\\\\\n                                        if value else self.unfocused_color)\\n\\n    @classmethod\\n    def from_values(cls, **kwargs):\\n        return cls(**kwargs)\\n        class Model:\\n            def get_title(self): return title or ''\\n            def get_label(self): return label or ''\\n            def get_color(self): return color or (1, 0, 0, 1)\\n            def get_actions(self): return actions\\n        return cls(world, Model(), line_numbers=line_numbers, **kwargs)\\n\\n    def open_context_menu(self, position=None):\\n        world.apps['Menus'].create_menu(self.actions, focus_parent=self.focus, hud=self.hud, position=self.button.layout.position if position is None else position).show()\\n\\n    def on_right_click(self, pos, ray, intersection):\\n        if self.focusable:\\n            world.focus.set_focus(self.focus)\\n        self.open_context_menu(position=intersection - ray.direction * 0.2)\\n\\n    def on_click(self, pos, ray, intersection):\\n        if self.focusable:\\n            world.focus.set_focus(self.focus)\\n        if self.actions:\\n            self.actions[0][1]()\\n\\n    def intersect(self, ray):\\n        return self.button.intersect(ray)\\n\\n    def label_changed(self):\\n        self.button.labels[0].text.set(self.label_model.get())\\n\\n    #def on_click(self, pos, ray, intersection):\\n    #    self.triggered.emit()\\n\\n    #@property\\n    #def position(self):\\n    #    return self.button.layout.position\\n\\n    #def set_position(self, position):\\n    #    self.button.layout.set_position(position)\\n\\n    #@property\\n    #def rotation(self):\\n    #    return self.button.layout.rotation\\n\\n    #def set_rotation(self, rotation):\\n    #    self.button.layout.set_rotation(rotation)\\n\\n    def debounced_camera_position_changed(self):\\n        return # TODO causes some problem\\n        if np.linalg.norm(self.button.layout.position - world.camera.debounced_camera_position.position) < 300:\\n            self.button.label.show_text()\\n        else:\\n            self.button.label.hide_text()\\n\\n    def drop(self):\\n        if not self.hud:\\n            world.camera.debounced_camera_position.changed.disconnect(self.debounced_camera_position_changed)\\n        if isinstance(self.model and self.label_model, z.ReactiveValue):\\n            self.label_model.changed.disconnect(self.label_changed)\\n        self.button.drop()\\n        if self.focus:\\n            self.focus.drop()\\n        #if self.tooltip:\\n        #    world.tooltips.drop_tooltip(self.tooltip)\\n\\n\\nclass ContextButtonLod1:\\n    def __init__(self, world, model, size=None):\\n        self.model = model\\n        self.rectangle = Rectangle(color=model.get_color())\\n        if hasattr(model, 'position'):\\n            self.rectangle.layout.set_position(model.position)\\n        size = size if size is not None else (20, 10, 1)\\n        self.rectangle.layout.set_constraints(BoxConstraints(min=size, max=size))\\n        self.focus = None\\n\\n        self.layout = self.rectangle.layout\\n        self.spatiolator = Spatiolator(self.layout, self.rectangle)\\n\\n    def updater(self):\\n        self.rectangle.updater()\\n\\n    @property\\n    def position(self):\\n        return self.rectangle.layout.position\\n\\n    @property\\n    def size(self):\\n        return self.rectangle.get_size()\\n\\n    def set_position(self, position):\\n        self.rectangle.layout.set_position(position)\\n\\n    def drop(self):\\n        self.rectangle.drop()\\n        if self.focus:\\n            self.focus.drop()\\n\", \"name\": \"ContextButton\"}", "created_at": null, "updated_at": 1751906432.7452102}