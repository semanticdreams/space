{"id": "436", "type": "class", "data": "{\"code_str\": \"class GraphEntityView:\\n    def __init__(self, entity, focus_parent=None):\\n        self.focus = (focus_parent or world.focus).add_child(self)\\n        self.entity = entity\\n        assert isinstance(self.entity.id, str)\\n\\n        #self.profiler = z.Profiler('graph-entity-view')\\n\\n        self.actions_panel = z.ActionsPanel([\\n            ('copy entity', self.entity.copy),\\n            ('paste entity as node', self.paste_triggered),\\n            ('show graph', self.show_graph_triggered),\\n            ('hide graph', self.hide_graph_triggered),\\n            ('create entity', self.create_entity_triggered),\\n        ], focus_parent=self.focus)\\n\\n        self.link_source_entity = None\\n        self.link_target_entity = None\\n        self.link_label = z.Label('Link: ')\\n        self.link_source_button = z.Button('<paste source>', focus_parent=self.focus)\\n        self.link_source_button.clicked.connect(self.on_link_source_clicked)\\n        self.link_target_button = z.Button('<paste target>', focus_parent=self.focus)\\n        self.link_target_button.clicked.connect(self.on_link_target_clicked)\\n        self.link_submit_button = z.Button('submit', focus_parent=self.focus)\\n        self.link_submit_button.clicked.connect(self.on_link_submit_clicked)\\n        self.unlink_button = z.Button('unlink', focus_parent=self.focus)\\n        self.unlink_button.clicked.connect(self.on_unlink_clicked)\\n        self.link_row = z.Flex([\\n            z.FlexChild(self.link_label.layout),\\n            z.FlexChild(self.link_source_button.layout),\\n            z.FlexChild(self.link_target_button.layout),\\n            z.FlexChild(self.link_submit_button.layout),\\n            z.FlexChild(self.unlink_button.layout),\\n        ])\\n\\n        self.force_layout = z.ForceLayout(\\n            spring_rest_length=self.entity.force_layout_params.get('spring_rest_length', 50),\\n            repulsive_force_constant=self.entity.force_layout_params.get('repulsive_force_constant', 6250),\\n            spring_constant=self.entity.force_layout_params.get('spring_constant', 1),\\n            max_displacement_squared=self.entity.force_layout_params.get('max_displacement_squared', 100),\\n            center_force=self.entity.force_layout_params.get('center_force', 0.0001),\\n            stabilized_max_displacement=self.entity.force_layout_params.get('stabilized_max_displacement', 0.02),\\n            stabilized_avg_displacement=self.entity.force_layout_params.get('stabilized_avg_displacement', 0.01),\\n        )\\n        self.force_layout.stabilized.connect(self.on_force_layout_stabilized)\\n\\n        self.force_layout_view = z.ForceLayoutView(self.force_layout)\\n        self.force_layout_view.params_changed.connect(\\n            self.save_force_layout_params)\\n\\n        self.column = z.Flex([\\n            z.FlexChild(self.actions_panel.layout),\\n            z.FlexChild(self.link_row.layout),\\n            z.FlexChild(self.force_layout_view.layout),\\n        ], axis='y', xalign='largest')\\n\\n        self.layout = self.column.layout\\n\\n        self.layout_root = z.LayoutRoot()\\n\\n        self.graph_layout = z.Layout(\\n            measurer=self.graph_measurer,\\n            layouter=self.graph_layouter,\\n            uses_child_measures=True,\\n            name=f'graph-entity-{self.entity.id}'\\n        )\\n        self.graph_layout.set_root(self.layout_root)\\n        self.graph_layout.position = np.array((0, 300, 0), float)\\n        self.graph_layout.mark_measure_dirty()\\n\\n        self.node_objs = {}\\n        self.points = {}\\n        self.edge_lines = {}\\n\\n        self.update_graph()\\n\\n        world.camera.debounced_camera_position.changed.connect(self.debounced_camera_position_changed)\\n        world.updated.connect(self.update)\\n\\n    def __str__(self):\\n        return str(self.entity)\\n\\n    def paste_triggered(self):\\n        assert Y.register_type == 'entity', Y.register_type\\n        entity = Y.value\\n        self.entity.add_node(entity)\\n        self.entity.save()\\n        self.update_graph()\\n\\n    def create_entity_triggered(self):\\n        def on_submitted(item):\\n            entity = item[0].create()\\n            self.entity.add_node(entity)\\n            self.entity.save()\\n            self.update_graph()\\n        world.floaties.add(z.CreateEntityView(on_submitted=on_submitted))\\n\\n    def show_graph_triggered(self):\\n        self.update_graph()\\n\\n    def hide_graph_triggered(self):\\n        self.clear_graph()\\n\\n    def on_link_source_clicked(self, f, i, d):\\n        assert Y.register_type == 'entity', Y.register_type\\n        self.link_source_entity = Y.value\\n        self.link_source_button.set_text(f'source: {self.link_source_entity}')\\n\\n    def on_link_target_clicked(self, f, i, d):\\n        assert Y.register_type == 'entity', Y.register_type\\n        self.link_target_entity = Y.value\\n        self.link_target_button.set_text(f'target: {self.link_target_entity}')\\n\\n    def on_link_submit_clicked(self, f, i, d):\\n        assert self.link_source_entity and self.link_target_entity\\n        self.entity.add_edge(self.link_source_entity, self.link_target_entity)\\n        self.entity.save()\\n        self.update_graph()\\n\\n    def on_unlink_clicked(self, f, i, d):\\n        assert self.link_source_entity and self.link_target_entity\\n        self.entity.remove_edge(self.link_source_entity, self.link_target_entity)\\n        self.entity.save()\\n        self.update_graph()\\n\\n    def debounced_camera_position_changed(self):\\n        for obj in self.node_objs.values():\\n            distance = np.linalg.norm(obj.layout.position - world.camera.debounced_camera_position.position)\\n            if distance < 500:\\n                obj.switch_view_mode('preview')\\n            else:\\n                obj.switch_view_mode('point')\\n\\n    def update_graph(self):\\n        self.clear_graph()\\n        for node_id in self.entity.nodes:\\n            assert isinstance(node_id, str)\\n            try:\\n                entity = world.apps['Entities'].get_entity(node_id)\\n            except z.EntityNotFoundError:\\n                self.entity.remove_node(node_id)\\n                self.entity.save()\\n            assert isinstance(entity.id, str)\\n            if entity:\\n                self.add_node_obj(entity)\\n        for edge in self.entity.edges:\\n            source_entity = world.apps['Entities'].get_entity(edge['source_id'])\\n            target_entity = world.apps['Entities'].get_entity(edge['target_id'])\\n            if source_entity and target_entity:\\n                self.add_edge_line(source_entity, target_entity, edge['label'])\\n        self.update_force_layout()\\n\\n    def add_node_obj(self, entity):\\n        if entity.id in self.node_objs:\\n            return\\n        obj = z.GraphEntityViewChild(self, entity, focus_parent=self.focus)\\n        self.node_objs[entity.id] = obj\\n        self.graph_layout.add_child(obj.layout)\\n        world.apps['Spatiolation'].add_spatiolatable(obj, on_moved=lambda drag: self.on_obj_moved())\\n        #obj.layout.position = np.random.rand(3) * 10\\n        #obj.layout.mark_measure_dirty()\\n        self.graph_layout.mark_measure_dirty()\\n\\n    def remove_node(self, entity_id):\\n        self.entity.remove_node(entity_id)\\n        self.entity.save()\\n        self.update_graph()\\n\\n    def add_edge_line(self, source_entity, target_entity, label=None):\\n        edge_key = (source_entity.id, target_entity.id)\\n        if source_entity.id not in self.node_objs or target_entity.id not in self.node_objs:\\n            return\\n        source_obj = self.node_objs[source_entity.id]\\n        target_obj = self.node_objs[target_entity.id]\\n        line = z.TriangleLine(\\n            source_obj.layout.position + source_obj.layout.size / 2,\\n            target_obj.layout.position + target_obj.layout.size / 2\\n        )\\n        self.edge_lines[edge_key] = line\\n        line.update()\\n\\n    def update_edge_lines(self):\\n        for line in self.edge_lines.values():\\n            line.drop()\\n        self.edge_lines.clear()\\n        for edge in self.entity.edges:\\n            source_entity = world.apps['Entities'].get_entity(edge['source_id'])\\n            target_entity = world.apps['Entities'].get_entity(edge['target_id'])\\n            if source_entity and target_entity:\\n                self.add_edge_line(source_entity, target_entity, edge['label'])\\n\\n    def update_force_layout(self, run_force=True):\\n        self.force_layout.clear()\\n        indices = {}\\n        for i, (node_id, node_obj) in enumerate(self.node_objs.items()):\\n            self.force_layout.add_node(node_obj.layout.position)\\n            indices[node_obj] = i\\n        for edge in self.entity.edges:\\n            if edge['source_id'] in self.node_objs and edge['target_id'] in self.node_objs:\\n                source_obj = self.node_objs[edge['source_id']]\\n                target_obj = self.node_objs[edge['target_id']]\\n                self.force_layout.add_edge(indices[source_obj], indices[target_obj])\\n        self.force_layout.position = self.graph_layout.position.copy()\\n        if run_force and self.node_objs:\\n            self.last_force_layout_position_update = time.time()\\n            self.force_layout.start()\\n\\n    def save_force_layout_params(self):\\n        self.entity.force_layout_params = {\\n            'repulsive_force_constant': self.force_layout.repulsive_force_constant,\\n            'spring_rest_length': self.force_layout.spring_rest_length,\\n            'spring_constant': self.force_layout.spring_constant,\\n            'max_displacement_squared': self.force_layout.max_displacement_squared,\\n            'center_force': self.force_layout.center_force,\\n            'stabilized_max_displacement': self.force_layout.stabilized_max_displacement,\\n            'stabilized_avg_displacement': self.force_layout.stabilized_avg_displacement,\\n        }\\n        self.entity.save()\\n\\n    def save_positions(self):\\n        for entity_id, node_obj in self.node_objs.items():\\n            self.entity.positions[entity_id] = node_obj.layout.position.tolist()\\n        self.entity.save()\\n\\n    def on_obj_moved(self):\\n        for i, (entity_id, node_obj) in enumerate(self.node_objs.items()):\\n            self.force_layout.positions[i][:2] = node_obj.layout.position[:2]\\n        self.save_positions()\\n\\n    def on_force_layout_stabilized(self):\\n        self.update_force_layout_positions()\\n        self.save_positions()\\n\\n    def clear_graph(self):\\n        self.graph_layout.clear_children()\\n        for node_obj in self.node_objs.values():\\n            world.apps['Spatiolation'].remove_spatiolatable(node_obj)\\n            node_obj.drop()\\n        self.node_objs.clear()\\n        for line in self.edge_lines.values():\\n            line.drop()\\n        self.edge_lines.clear()\\n\\n    def graph_measurer(self):\\n        for child in self.graph_layout.children:\\n            child.measurer()\\n\\n    def graph_layouter(self):\\n        for child in self.graph_layout.children:\\n            child.size = child.measure\\n            if not np.any(child.position):\\n                child.position = np.array((0, 0, 0), float)\\n            child.rotation = np.array((1, 0, 0, 0), float)\\n            child.layouter()\\n        self.update_edge_lines()\\n\\n    def update_force_layout_positions(self):\\n        self.last_force_layout_position_update = time.time()\\n        for i, obj in enumerate(self.node_objs.values()):\\n            obj.layout.position[:2] = self.force_layout.positions[i][:2]\\n        self.graph_layout.mark_layout_dirty()\\n\\n    def update(self, delta):\\n        #self.profiler.enable()\\n        self.force_layout.update()\\n        if self.force_layout.active \\\\\\n           and time.time() - self.last_force_layout_position_update > 0.3:\\n            self.update_force_layout_positions()\\n        self.layout_root.update()\\n        for edge_key, line in self.edge_lines.items():\\n            source_id, target_id = edge_key\\n            if source_id in self.node_objs and target_id in self.node_objs:\\n                source_obj = self.node_objs[source_id]\\n                target_obj = self.node_objs[target_id]\\n                line.start_position = source_obj.layout.position + source_obj.layout.size / 2\\n                line.end_position = target_obj.layout.position + target_obj.layout.size / 2\\n                line.update()\\n        #self.profiler.disable()\\n\\n    def drop(self):\\n        #self.profiler.dump()\\n        #self.profiler.svg()\\n        world.camera.debounced_camera_position.changed.disconnect(self.debounced_camera_position_changed)\\n        world.updated.disconnect(self.update)\\n        self.force_layout_view.params_changed.disconnect(\\n            self.save_force_layout_params)\\n        self.force_layout.drop()\\n        self.clear_graph()\\n        self.graph_layout.drop()\\n        self.layout_root.drop()\\n        self.column.drop()\\n        self.force_layout_view.drop()\\n        self.link_row.drop()\\n        self.link_label.drop()\\n        self.link_source_button.drop()\\n        self.link_target_button.drop()\\n        self.link_submit_button.drop()\\n        self.unlink_button.drop()\\n        self.actions_panel.drop()\\n        self.focus.drop()\\n\", \"name\": \"GraphEntityView\"}", "created_at": null, "updated_at": 1751906432.7447495}