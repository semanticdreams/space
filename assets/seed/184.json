{"id": "184", "type": "class", "data": "{\"code_str\": \"class ClaudeConversationView:\\n    def __init__(self, conversation):\\n        self.focus = world.focus.add_child(self)\\n        self.conversation = conversation\\n        self.name = z.ReactiveValue(self.make_name())\\n        self.messages = []\\n\\n        self.name_input = z.Input(text=self.conversation.data['name'] or '', focus_parent=self.focus)\\n        self.name_input.submitted.connect(self.on_name_submitted)\\n        self.auto_name_button = z.Button('auto-name', focus_parent=self.focus,\\n                on_click=self.on_auto_name_clicked)\\n        self.archive_button = z.Button('archive', focus_parent=self.focus)\\n        self.archive_button.clicked.connect(self.on_archive_clicked)\\n        self.clone_button = z.Button('clone', focus_parent=self.focus)\\n        self.clone_button.clicked.connect(self.on_clone_clicked)\\n        self.temperature_input = z.Input(text=str(self.conversation.data['temperature']), focus_parent=self.focus)\\n        self.temperature_input.submitted.connect(self.on_temperature_submitted)\\n        self.max_tokens_input = z.Input(text=str(self.conversation.data['max_tokens']), focus_parent=self.focus)\\n        self.max_tokens_input.submitted.connect(self.on_max_tokens_submitted)\\n        self.head_spacer = z.Spacer()\\n        self.head = z.Flex(children=[\\n            z.FlexChild(self.name_input.layout),\\n            z.FlexChild(self.auto_name_button.layout),\\n            z.FlexChild(self.archive_button.layout),\\n            z.FlexChild(self.clone_button.layout),\\n            z.FlexChild(self.temperature_input.layout),\\n            z.FlexChild(self.max_tokens_input.layout),\\n            z.FlexChild(self.head_spacer.layout, flex=1),\\n        ], yalign='largest')\\n\\n        self.system_input = z.Input(\\n            text=self.conversation.data['system'] or '',\\n            focus_parent=self.focus, multiline=True, min_lines=3, max_lines=3)\\n        self.system_input.submitted.connect(self.on_system_submitted)\\n\\n        self.tab_view = z.TabView([\\n            ('Tabs', self.tab_builder),\\n            ('Text', self.text_builder),\\n            #('List', self.list_builder)\\n        ], focus_parent=self.focus, horizontal=True)\\n\\n        self.input = z.Input(focus_parent=self.focus, max_lines=5, min_lines=5, multiline=True, actions=[\\n            ('paste', self.input_paste_triggered),\\n        ])\\n        self.input.submitted.connect(self.on_submitted)\\n\\n        self.send_button = z.Button('send', focus_parent=self.focus)\\n        self.send_button.clicked.connect(self.on_send_clicked)\\n\\n        self.bottom = z.Flex(children=[\\n            z.FlexChild(self.input.layout, flex=1),\\n            z.FlexChild(self.send_button.layout)\\n        ], yalign='largest')\\n\\n        self.column = z.Flex([\\n            z.FlexChild(self.head.layout),\\n            z.FlexChild(self.system_input.layout),\\n            z.FlexChild(self.tab_view.layout, flex=1),\\n            z.FlexChild(self.bottom.layout)\\n        ], axis='y', xalign='largest')\\n        self.layout = self.column.layout\\n\\n        self.load_messages()\\n\\n        world.focus.set_focus(self.input.focus)\\n\\n    def on_auto_name_clicked(self, f, i, d):\\n        def cb(value):\\n            self.name_input.set_text(value)\\n            self.conversation.data['name'] = value\\n            self.name.set(self.make_name())\\n        world.aio.create_task(self.conversation.auto_name(), cb)\\n\\n    def tab_builder(self, context):\\n        def make_message_builder(message):\\n            def b(context2):\\n                inp = z.Input(text='\\\\n'.join((message['content'], message['tool_uses'])) if message['tool_uses'] else (message['content'] or ''), multiline=True,\\n           # background_color=(0, 0.8, 0.8, 1) if message['role'] == 'assistant' else (0, 1.0, 0.5, 1),\\n                                       actions=[\\n                                           ('archive', lambda message=message: self.archive_message_triggered(message)),\\n                                           ('edit role', lambda message=message: self.edit_role_triggered(message)),\\n                                           ('xml', lambda message=message: self.xml_triggered(message)),\\n                                       ],\\n                                       chars_per_line=80,\\n                                       focus_parent=context2['focus_parent'])\\n                inp.submitted.connect(lambda: self.conversation.set_message_content(message['id'], inp.text))\\n                return inp\\n            return b\\n        tabs = [((('> ' if x['role'] == 'assistant' else '') \\\\\\n                 + 'tool result' if x['type'] == 'tool_result' else x['content'].split('\\\\n')[0])[:20], make_message_builder(x)) for x in self.messages]\\n        tab_view = z.TabView(tabs, focus_parent=context['focus_parent'],\\n                                     horizontal=False, initial_tab=-1)\\n        return tab_view\\n\\n    def text_builder(self, context):\\n        format_reply = lambda s: '\\\\n'.join(('> ' + x for x in s.split('\\\\n')))\\n        text = '\\\\n\\\\n'.join([(x['content'] if x['role'] == 'user' else format_reply(x['content']))\\n                            for x in self.messages])\\n        return z.Input(text=text,\\n                               multiline=True,\\n                               min_width=80, chars_per_line=80,\\n                               focus_parent=context['focus_parent'])\\n\\n    #def list_builder(self, context):\\n    #    list_view = z.ListView(self.messages, builder=self.builder, focus_parent=context['focus_parent'], show_head=False)\\n    #    return list_view\\n\\n    def input_paste_triggered(self):\\n        prev_inserting = self.input.inserting\\n        self.input.set_inserting(True)\\n        for char in world.apps['Clipboard'].get_text():\\n            self.input.insert_char(char)\\n        self.input.set_inserting(prev_inserting)\\n\\n    def make_name(self):\\n        return f'Claude Conversation {self.conversation.data[\\\"id\\\"]}: {self.conversation.data[\\\"name\\\"] or \\\"\\\"}'\\n\\n    def edit_role_triggered(self, message):\\n        message['role'] = world.dialogs.edit_string(message['role']).strip()\\n        self.conversation.set_message_role(message['id'], message['role'])\\n        self.messages_updated()\\n\\n    def xml_triggered(self, message):\\n        world.floaties.add(z.XMLView.from_text(message['content']))\\n\\n    def on_system_submitted(self):\\n        value = self.system_input.text\\n        self.conversation.set_system(value)\\n\\n    def on_temperature_submitted(self):\\n        value = float(self.temperature_input.text)\\n        self.conversation.set_temperature(value)\\n\\n    def on_max_tokens_submitted(self):\\n        value = int(self.max_tokens_input.text)\\n        self.conversation.set_max_tokens(value)\\n\\n    def on_name_submitted(self):\\n        new_name = self.name_input.text\\n        self.conversation.set_name(new_name)\\n        self.name.set(self.make_name())\\n\\n    def on_archive_clicked(self, f, i, d):\\n        self.conversation.set_archived()\\n        world.floaties.drop_obj(self)\\n\\n    def on_clone_clicked(self, f, i, d):\\n        conversation = self.conversation.clone()\\n        world.floaties.add(ClaudeConversationView(conversation))\\n\\n    def archive_message_triggered(self, message):\\n        self.conversation.archive_message(message['id'])\\n        self.load_messages()\\n\\n    def messages_updated(self):\\n        #self.list_view.set_items(self.messages)\\n        self.tab_view.reload_current_tab()\\n\\n    def load_messages(self):\\n        self.messages = self.conversation.get_messages()\\n        self.messages_updated()\\n        self.send_button.set_text('send')\\n\\n    def on_send_clicked(self, f, i, d):\\n        self.send_button.set_text('sending...')\\n        self.send_messages()\\n\\n    def on_submitted(self):\\n        value = self.input.text.strip()\\n        if value:\\n            user_message = self.conversation.insert_message(value, 'user')\\n            self.load_messages()\\n        self.input.set_text('')\\n\\n    def send_messages(self):\\n        world.aio.create_task(self.conversation.send(),\\n            lambda _: self.load_messages())\\n\\n    def drop(self):\\n        self.column.drop()\\n        self.head.drop()\\n        self.name_input.drop()\\n        self.auto_name_button.drop()\\n        self.system_input.drop()\\n        self.temperature_input.drop()\\n        self.max_tokens_input.drop()\\n        self.archive_button.drop()\\n        self.clone_button.drop()\\n        self.head_spacer.drop()\\n        self.bottom.drop()\\n        self.input.drop()\\n        self.send_button.drop()\\n        self.tab_view.drop()\\n        self.focus.drop()\\n\", \"name\": \"ClaudeConversationView\"}", "created_at": null, "updated_at": 1754736945.4978578}