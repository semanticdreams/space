{"id": "182", "type": "class", "data": "{\"code_str\": \"import time\\nimport json\\nimport jinja2\\n\\nmacros = \\\"\\\"\\\"\\n{% macro class(name) %}\\n  {{ world.classes.get_class_code(name=name)['code'] }}\\n{% endmacro %}\\n{% macro classes(names) %}\\n  {% for name in names %}\\n    {{ world.classes.get_class_code(name=name)['code'] }}\\n  {% endfor %}\\n{% endmacro %}\\n\\\"\\\"\\\"\\n\\nclass ClaudeConversation:\\n    def __init__(self, data):\\n        self.data = data\\n\\n    def insert_message(self, content, role='user', num_tokens=None,\\n                       type='text', tool_use_id=None):\\n        message = {'role': role, 'content': content, 'claude_conversation_id': self.data['id'],\\n                   'num_tokens': num_tokens, 'type': type, 'tool_use_id': tool_use_id}\\n        with world.db:\\n            cur = world.db.execute(\\n                'insert into claude_conversation_messages (claude_conversation_id, role, content, num_tokens, type, tool_use_id, created_at)'\\n                ' values (?, ?, ?, ?, ?, ?, ?)', (message['claude_conversation_id'], message['role'], message['content'], message['num_tokens'], type, tool_use_id, time.time()))\\n        message['id'] = cur.lastrowid\\n        return message\\n\\n    def add_tool(self, definition, code_id):\\n        with world.db:\\n            cur = world.db.execute(\\n                'insert into claude_conversation_tools (claude_conversation_id, definition, code_id)'\\n                ' values (?, ?, ?)',\\n                (self.data['id'], json.dumps(definition), code_id))\\n            id = cur.lastrowid\\n        return dict(id=id, definition=definition, code_id=code_id)\\n\\n    def get_tools(self):\\n        tools = list(map(dict, world.db.execute(\\n                        'select * from claude_conversation_tools'\\n                        ' where claude_conversation_id = ?',\\n                        (self.data['id'],)).fetchall()))\\n        for tool in tools:\\n            tool['definition'] = json.loads(tool['definition'])\\n        return tools\\n\\n    def set_temperature(self, value):\\n        with world.db:\\n            world.db.execute('update claude_conversations set temperature = ? where id = ?',\\n                             (value, self.data['id']))\\n        self.data['temperature'] = value\\n\\n    def set_system(self, value):\\n        with world.db:\\n            world.db.execute('update claude_conversations set system = ? where id = ?',\\n                             (value, self.data['id']))\\n        self.data['system'] = value\\n\\n    def set_max_tokens(self, value):\\n        with world.db:\\n            world.db.execute('update claude_conversations set max_tokens = ? where id = ?',\\n                             (value, self.data['id']))\\n        self.data['max_tokens'] = value\\n\\n    def set_name(self, value):\\n        with world.db:\\n            world.db.execute('update claude_conversations set name = ? where id = ?',\\n                             (value, self.data['id']))\\n        self.data['name'] = value\\n\\n    def set_message_role(self, message_id, role):\\n        assert role in ('user', 'assistant'), role\\n        with world.db:\\n            world.db.execute('update claude_conversation_messages set role = ? where id = ?',\\n                             (role, message_id))\\n\\n    def set_message_content(self, message_id, content):\\n        with world.db:\\n            world.db.execute('update claude_conversation_messages set content = ? where id = ?',\\n                             (content, message_id))\\n\\n    def set_message_num_tokens(self, message_id, num_tokens):\\n        with world.db:\\n            world.db.execute('update claude_conversation_messages set num_tokens = ? where id = ?',\\n                             (num_tokens, message_id))\\n\\n    def clone(self):\\n        with world.db:\\n            cur = world.db.execute('insert into claude_conversations (name, created_at) values (?, ?)',\\n                                   (self.data['name'], time.time()))\\n            new_conversation_id = cur.lastrowid\\n            for message in self.messages:\\n                world.db.execute('insert into claude_conversation_messages'\\n                                 ' (claude_conversation_id, role, content, created_at) values (?, ?, ?, ?)',\\n                                 (new_conversation_id, message['role'], message['content'], time.time()))\\n        conversation = {**self.data, 'id': new_conversation_id}\\n        return z.ClaudeConversation(conversation)\\n\\n    def render_messages(self, messages, template_args=None):\\n        result = []\\n        for x in messages:\\n            if x['type'] == 'tool_result':\\n                result.append(dict(role=x['role'], content=[dict(type='tool_result', tool_use_id=x['tool_use_id'], content=x['content'])]))\\n            else:\\n                result.append(dict(role=x['role'], content=jinja2.Template(macros + x['content']).render(world=world, **(template_args or {}))))\\n                if x['tool_uses']:\\n                    for use in json.loads(x['tool_uses']):\\n                        result.append(dict(role=x['role'], content=[dict(type='tool_use', id=use['id'], name=use['name'], input=use['input'])]))\\n        return result\\n\\n    def add_tool_use(self, message_id, tool_use_id, name, input):\\n        message = self.get_message(message_id)\\n        tool_uses = []\\n        if message['tool_uses'] is not None:\\n            tool_uses = json.loads(message['tool_uses'])\\n        tool_uses.append(dict(id=tool_use_id, name=name, input=input))\\n        with world.db:\\n            world.db.execute('update claude_conversation_messages'\\n                ' set tool_uses = ? where id = ?',\\n                (json.dumps(tool_uses), message_id))\\n\\n    async def send(self, template_args=None):\\n        messages = self.render_messages(self.get_messages(), template_args=template_args)\\n        tools = self.get_tools()\\n        response = await world.apps['Claude'].send(\\n                messages=messages, system=self.data['system'],\\n                tools=[x['definition'] for x in tools],\\n                max_tokens=self.data['max_tokens'],\\n                temperature=self.data['temperature'])\\n        message = None\\n        for item in response.content:\\n            if item.type == 'text':\\n                message = self.insert_message(item.text, response.role,\\n                    response.usage.output_tokens)\\n            elif item.type == 'tool_use':\\n                self.add_tool_use(message['id'], item.id, item.name, item.input)\\n                tool = one([x for x in tools if x['definition']['name'] == item.name])\\n                code = world.codes.get_code(tool['code_id'])\\n                kernel = world.kernels.ensure_kernel(code['kernel'])\\n                kernel.send_code(code, catch_errors=True)\\n                func = kernel.env.pop(code['name'])\\n                result = func(**item.input)\\n                self.insert_message(str(result) if result is not None else None, 'user',\\n                                    type='tool_result', tool_use_id=item.id)\\n                if result is not None:\\n                    return await self.send(template_args)\\n            else:\\n                assert False, item.type\\n        return message\\n\\n    async def auto_name(self):\\n        messages = self.get_messages()\\n        assert messages\\n        #msg = 'SYSTEM: {self.data[\\\"system\\\"]}\\\\nMESSAGES: {\\\"\\\\n\\\".join((x['content'] for x in [messages[0]]))}'\\n        msg = 'SYSTEM: {}\\\\nMESSAGES: {}'.format(self.data['system'], '\\\\n'.join((x['content'] for x in [messages[0]])))\\n        system = ('You generate short (max 8 words) titles of entire conversations with you.')\\n        resp = await world.apps['Claude'].send(\\n            [{'role': 'user', 'content': msg},\\n             {'role': 'assistant', 'content': 'The title is:'}],\\n            system=system, max_tokens=100, temperature=0.6)\\n        value = '> ' + resp.content[0].text.strip().strip('\\\"')\\n        self.set_name(value)\\n        return value\\n\\n    def update_num_tokens(self, message_id):\\n        # need to retrieve message, prep it like in send,\\n        # then send it to world.apps['Claude'].count_tokens same way like send\\n        # and use result to update db with self.set_message_num_tokens\\n        pass\\n\\n    def set_archived(self):\\n        self.data['archived_at'] = time.time()\\n        with world.db:\\n            world.db.execute('update claude_conversations set archived_at = ? where id = ?',\\n                             (self.data['archived_at'], self.data['id']))\\n\\n    def archive_message(self, message_id):\\n        with world.db:\\n            world.db.execute('update claude_conversation_messages set archived_at = ? where id = ?',\\n                             (time.time(), message_id))\\n\", \"name\": \"ClaudeConversation\"}", "created_at": null, "updated_at": 1754736945.4788475}