{"id": "312", "type": "class", "data": "{\"code_str\": \"import time\\nfrom util import multi_intersect, ray_from_screen_pos\\n\\n\\nclass Clickables:\\n    def __init__(self):\\n        self.projection = world.projection\\n        self.viewport = world.viewport\\n        self.camera = world.camera.camera\\n\\n        self.active = None\\n\\n        self.last_click = None\\n        self.last_click_pos = None\\n\\n        self.right_click_objs = []\\n        self.right_click_void_callbacks = []\\n\\n        self.double_click_objs = []\\n\\n        self.objs = []\\n        self.left_click_void_callbacks = []\\n\\n        self.mouse_down_pos = None\\n\\n        world.states.create_state(name='clickables', on_enter=self.on_enter,\\n                                  on_leave=self.on_leave)\\n\\n        world.vim.modes['normal'].add_action_group(z.VimActionGroup('clickables', [\\n            z.VimAction('enable-clickables', self.enable_clickables, sdl2.SDLK_l),\\n        ]))\\n\\n    def enable_clickables(self):\\n        world.states.transit(state_name='clickables')\\n        world.vim.set_current_mode('normal')\\n\\n    def on_enter(self):\\n        world.window.mouse_button.connect(self.on_mouse_button)\\n        world.window.keyboard.connect(self.on_keyboard)\\n\\n    def on_leave(self):\\n        world.window.mouse_button.disconnect(self.on_mouse_button)\\n        world.window.keyboard.disconnect(self.on_keyboard)\\n\\n    def on_keyboard(self, key, scancode, action, mods):\\n        if action == 1 and key == sdl2.SDLK_ESCAPE:\\n            world.states.transit_back()\\n\\n    def register(self, obj):\\n        self.objs.append(obj)\\n\\n    def register_right_click(self, obj):\\n        self.right_click_objs.append(obj)\\n\\n    def register_right_click_void_callback(self, func):\\n        self.right_click_void_callbacks.append(func)\\n\\n    def register_double_click(self, obj):\\n        self.double_click_objs.append(obj)\\n\\n    def register_left_click_void_callback(self, func):\\n        self.left_click_void_callbacks.append(func)\\n\\n    def unregister_left_click_void_callback(self, func):\\n        self.left_click_void_callbacks.remove(func)\\n\\n    def unregister(self, obj):\\n        self.objs.remove(obj)\\n\\n    def unregister_right_click(self, obj):\\n        self.right_click_objs.remove(obj)\\n\\n    def unregister_right_click_void_callback(self, func):\\n        self.right_click_void_callbacks.remove(func)\\n\\n    def unregister_double_click(self, obj):\\n        self.double_click_objs.remove(obj)\\n\\n    def on_mouse_button(self, button, action, mods):\\n        pos = world.window.mouse_pos\\n        hud_ray = ray_from_screen_pos(pos, world.camera['identity'].get_view_matrix(), world.hud_projection.value,\\n                                      self.viewport.value)\\n        ray = ray_from_screen_pos(pos, self.camera.get_view_matrix(), self.projection.value,\\n                                  self.viewport.value)\\n\\n        is_near = lambda p1, p2, rsq=100: (p1[0] - p2[0])**2 + (p1[1] - p2[1])**2 < rsq\\n\\n        if action == 1:\\n            self.mouse_down_pos = pos\\n            f, i, d, o = multi_intersect(\\n                hud_ray,\\n                [x for x in ((self.double_click_objs + self.objs) if button == sdl2.SDL_BUTTON_LEFT else self.right_click_objs) if x.hud],\\n                include_obj=True\\n            )\\n            if not f:\\n                f, i, d, o = multi_intersect(\\n                    ray,\\n                    [x for x in ((self.double_click_objs + self.objs) if button == sdl2.SDL_BUTTON_LEFT else self.right_click_objs) if not x.hud],\\n                    include_obj=True\\n                )\\n            if f:\\n                self.active = (i, d, o)\\n        elif action == 0 and is_near(self.mouse_down_pos, pos):\\n            if self.active:\\n                if button == sdl2.SDL_BUTTON_LEFT:\\n                    self.active[2].on_click(pos, ray, self.active[0])\\n                    now = time.time()\\n                    if self.last_click and now - self.last_click < 0.5 and is_near(self.last_click_pos, pos):\\n                        self.last_click = None\\n                        self.active[2].on_double_click(pos, ray, self.active[0])\\n                    else:\\n                        self.last_click = now\\n                        self.last_click_pos = pos\\n                elif action == 0 and button == sdl2.SDL_BUTTON_RIGHT:\\n                    self.active[2].on_right_click(pos, ray, self.active[0])\\n            else:\\n                if button == sdl2.SDL_BUTTON_LEFT:\\n                    for func in self.left_click_void_callbacks:\\n                        func(pos, ray)\\n                elif button == sdl2.SDL_BUTTON_RIGHT:\\n                    for func in self.right_click_void_callbacks:\\n                        func(pos, ray)\\n        if action == 0 and self.active:\\n            self.active = None\\n\\n    def drop(self):\\n        pass\\n\", \"name\": \"Clickables\"}", "created_at": null, "updated_at": 1756754129.7227213}